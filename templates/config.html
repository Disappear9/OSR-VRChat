<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSR-VRChat 配置界面</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- uPlot CSS -->
    <link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css" />
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f8fafc;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .config-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2.5rem;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .config-section {
            padding: 2rem;
        }

        .section-title {
            color: var(--dark-color);
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-connected {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background-color: var(--danger-color);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: var(--dark-color);
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 0 15px 15px 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .input-group-text {
            background: var(--light-color);
            border: 2px solid #e5e7eb;
            border-radius: 10px 0 0 10px;
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        /* Chart Grid Styles */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            grid-gap: 20px;
            max-width: 100%;
            margin: 20px 0;
        }

        .chart-container {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            width: 100%;
            height: 300px;
            margin: 0;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        .chart-title {
            position: absolute;
            top: 10px;
            left: 15px;
            color: #000;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .osr-btn-max {
            background-color: #198754 !important;
            border-color: #198754 !important;
            color: white !important;
            padding: 8px 12px !important;
        }

        .osr-btn-max:hover {
            background-color: #157347 !important;
            border-color: #146c43 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .osr-btn-min {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #212529 !important;
            padding: 8px 12px !important;
        }

        .osr-btn-min:hover {
            background-color: #ffca2c !important;
            border-color: #ffc720 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="config-container">
            <!-- Header -->
            <div class="header">
                <h1><i class="bi bi-gear-fill"></i> OSR-VRChat 配置</h1>
            </div>

            <!-- Status Section -->
            <div class="config-section">
                <div class="row">
                    <div class="col-md-4">
                        <div class="status-card">
                            <h6><i class="bi bi-usb-symbol"></i> 设备状态</h6>
                            <p><span id="device-status" class="status-indicator status-disconnected"></span><span
                                    id="device-text">未连接</span></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="status-card">
                            <h6><i class="bi bi-wifi"></i> OSC 状态</h6>
                            <p><span id="osc-status" class="status-indicator status-disconnected"></span><span
                                    id="osc-text">未连接</span></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="status-card">
                            <h6><i class="bi bi-activity"></i> 运行状态</h6>
                            <p><span id="running-status" class="status-indicator status-disconnected"></span><span
                                    id="running-text">已停止</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tabs -->
            <div class="config-section">
                <ul class="nav nav-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="osr-tab" data-bs-toggle="tab" data-bs-target="#osr-config"
                            type="button" role="tab">
                            <i class="bi bi-cpu"></i> OSR 设备配置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="vrchat-tab" data-bs-toggle="tab" data-bs-target="#vrchat-config"
                            type="button" role="tab">
                            <i class="bi bi-headset-vr"></i> VRChat 配置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network-config"
                            type="button" role="tab">
                            <i class="bi bi-router"></i> 网络配置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab"
                            data-bs-target="#advanced-config" type="button" role="tab">
                            <i class="bi bi-sliders"></i> 高级设置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="monitor-tab" data-bs-toggle="tab" data-bs-target="#monitor-config"
                            type="button" role="tab">
                            <i class="bi bi-graph-up"></i> 数据监控
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="configTabContent">
                    <!-- OSR Device Configuration -->
                    <div class="tab-pane fade show active" id="osr-config" role="tabpanel">
                        <form id="osr-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="com_port" class="form-label"><i class="bi bi-usb"></i> 串口端口</label>
                                        <input type="text" class="form-control" id="com_port" name="com_port">
                                        </input>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="use_udp"
                                                name="use_udp">
                                            <label class="form-check-label" for="use_udp">
                                                <i class="bi bi-wifi"></i> UDP连接
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="udp_server_ip" class="form-label"><i class="bi bi-server"></i> UDP服务器IP</label>
                                        <input type="text" class="form-control" id="udp_server_ip" name="udp_server_ip">
                                        </input>
                                    </div>
                                    <div class="mb-3">
                                        <label for="udp_server_port" class="form-label"><i class="bi bi-ethernet"></i> UDP端口</label>
                                        <input type="text" class="form-control" id="udp_server_port" name="udp_server_port">
                                        </input>
                                    </div>
                                    <div class="mb-3">
                                        <label for="objective" class="form-label"><i class="bi bi-arrow-down-right"></i>
                                            动作目标</label>
                                        <select class="form-select" id="objective" name="objective">
                                            <option value="inserting_others">插入别人</option>
                                            <option value="inserting_self">插入自己</option>
                                            <option value="inserted_pussy">被插入（小穴）</option>
                                            <option value="inserted_ass">被插入（肛门）</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="l0_axis_invert"
                                                name="l0_axis_invert">
                                            <label class="form-check-label" for="l0_axis_invert">
                                                <i class="bi bi-arrow-repeat"></i> L0轴反转
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><i class="bi bi-joystick"></i> OSR 位置控制</label>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn flex-fill osr-btn-max"
                                                onclick="moveToMaxPosition()">
                                                <i class="bi bi-arrow-up-circle"></i> 移动到最大位置
                                            </button>
                                            <button type="button" class="btn flex-fill osr-btn-min"
                                                onclick="moveToMinPosition()">
                                                <i class="bi bi-arrow-down-circle"></i> 移动到最小位置
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max_pos" class="form-label"><i class="bi bi-arrow-up-circle"></i>
                                            最大位置</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="max_pos" name="max_pos"
                                                min="0" max="999">
                                            <span class="input-group-text">/ 999</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="min_pos" class="form-label"><i class="bi bi-arrow-down-circle"></i>
                                            最小位置</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="min_pos" name="min_pos"
                                                min="0" max="999">
                                            <span class="input-group-text">/ 999</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="max_velocity" class="form-label"><i class="bi bi-speedometer2"></i>
                                            最大速度</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="max_velocity"
                                                name="max_velocity" min="1">
                                            <span class="input-group-text">单位/秒</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="updates_per_second" class="form-label"><i
                                                class="bi bi-arrow-clockwise"></i> 更新频率</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="updates_per_second"
                                                name="updates_per_second" min="1" max="100">
                                            <span class="input-group-text">次/秒</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- VRChat Configuration -->
                    <div class="tab-pane fade" id="vrchat-config" role="tabpanel">
                        <form id="vrchat-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="vrchat_max" class="form-label"><i class="bi bi-bar-chart-line"></i>
                                            VRChat 最大值</label>
                                        <input type="number" class="form-control" id="vrchat_max" name="vrchat_max">
                                    </div>
                                    <div class="mb-3">
                                        <label for="vrchat_min" class="form-label"><i class="bi bi-bar-chart-line"></i>
                                            VRChat 最小值</label>
                                        <input type="number" class="form-control" id="vrchat_min" name="vrchat_min">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="inserting_others" class="form-label"><i class="bi bi-link"></i>
                                            插入别人参数路径</label>
                                        <input type="text" class="form-control" id="inserting_others"
                                            name="inserting_others">
                                    </div>
                                    <div class="mb-3">
                                        <label for="inserting_self" class="form-label"><i class="bi bi-link"></i>
                                            插入自己参数路径</label>
                                        <input type="text" class="form-control" id="inserting_self"
                                            name="inserting_self">
                                    </div>
                                    <div class="mb-3">
                                        <label for="inserted_pussy" class="form-label"><i class="bi bi-link"></i>
                                            被插入（小穴）参数路径</label>
                                        <input type="text" class="form-control" id="inserted_pussy"
                                            name="inserted_pussy">
                                    </div>
                                    <div class="mb-3">
                                        <label for="inserted_ass" class="form-label"><i class="bi bi-link"></i>
                                            被插入（肛门）参数路径</label>
                                        <input type="text" class="form-control" id="inserted_ass" name="inserted_ass">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Network Configuration -->
                    <div class="tab-pane fade" id="network-config" role="tabpanel">
                        <form id="network-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-broadcast"></i> OSC 配置</h6>
                                    <div class="mb-3">
                                        <label for="osc_listen_host" class="form-label">监听地址</label>
                                        <input type="text" class="form-control" id="osc_listen_host"
                                            name="osc_listen_host">
                                    </div>
                                    <div class="mb-3">
                                        <label for="osc_listen_port" class="form-label">监听端口</label>
                                        <input type="number" class="form-control" id="osc_listen_port"
                                            name="osc_listen_port" min="1" max="65535">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-globe"></i> Web 服务器配置</h6>
                                    <div class="mb-3">
                                        <label for="web_listen_host" class="form-label">监听地址</label>
                                        <input type="text" class="form-control" id="web_listen_host"
                                            name="web_listen_host">
                                    </div>
                                    <div class="mb-3">
                                        <label for="web_listen_port" class="form-label">监听端口</label>
                                        <input type="number" class="form-control" id="web_listen_port"
                                            name="web_listen_port" min="1" max="65535">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Advanced Configuration -->
                    <div class="tab-pane fade" id="advanced-config" role="tabpanel">
                        <form id="advanced-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="log_level" class="form-label"><i class="bi bi-journal-text"></i>
                                            日志级别</label>
                                        <select class="form-select" id="log_level" name="log_level">
                                            <option value="DEBUG">DEBUG</option>
                                            <option value="INFO">INFO</option>
                                            <option value="WARNING">WARNING</option>
                                            <option value="ERROR">ERROR</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="auto_open_web_page"
                                                name="auto_open_web_page">
                                            <label class="form-check-label" for="auto_open_web_page">
                                                <i class="bi bi-qr-code"></i> 自动打开网页
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Monitor Configuration -->
                    <div class="tab-pane fade" id="monitor-config" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-4"><i class="bi bi-graph-up"></i> 实时数据监控</h5>
                                <div class="chart-grid">
                                    <div id="chart-container-1" class="chart-container">
                                        <div class="chart-title">Raw Level</div>
                                    </div>
                                    <div id="chart-container-2" class="chart-container">
                                        <div class="chart-title">Raw Velocity</div>
                                    </div>
                                    <div id="chart-container-3" class="chart-container">
                                        <div class="chart-title">Raw Acceleration</div>
                                    </div>
                                    <div id="chart-container-4" class="chart-container">
                                        <div class="chart-title">Cropped Velocity</div>
                                    </div>
                                    <div id="chart-container-5" class="chart-container">
                                        <div class="chart-title">Cropped Acceleration</div>
                                    </div>
                                    <div id="chart-container-6" class="chart-container">
                                        <div class="chart-title">Output Level</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary me-3" onclick="saveConfig()">
                        <i class="bi bi-save"></i> 保存配置
                    </button>

                    <button type="button" class="btn btn-secondary me-3" onclick="restartBackend()">
                        <i class="bi bi-arrow-clockwise"></i> 重新启动后端
                    </button>
                </div>


            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- uPlot JS -->
    <script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadConfig();
            updateStatus();
            // Update status every 2 seconds
            setInterval(updateStatus, 2000);
        });

        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // Populate OSR settings
                document.getElementById('com_port').value = config.osr2.com_port;
                document.getElementById('use_udp').checked = config.osr2.use_udp;
                document.getElementById('udp_server_ip').value = config.osr2.udp_server_ip;
                document.getElementById('udp_server_port').value = config.osr2.udp_server_port;
                document.getElementById('objective').value = config.osr2.objective;
                document.getElementById('max_pos').value = config.osr2.max_pos;
                document.getElementById('min_pos').value = config.osr2.min_pos;
                document.getElementById('max_velocity').value = config.osr2.max_velocity;
                document.getElementById('updates_per_second').value = config.osr2.updates_per_second;
                document.getElementById('l0_axis_invert').checked = config.osr2.l0_axis_invert;

                // Populate VRChat settings
                document.getElementById('vrchat_max').value = config.osr2.vrchat_max;
                document.getElementById('vrchat_min').value = config.osr2.vrchat_min;
                document.getElementById('inserting_others').value = config.osr2.inserting_others;
                document.getElementById('inserting_self').value = config.osr2.inserting_self;
                document.getElementById('inserted_pussy').value = config.osr2.inserted_pussy;
                document.getElementById('inserted_ass').value = config.osr2.inserted_ass;

                // Populate Network settings
                document.getElementById('osc_listen_host').value = config.osc.listen_host;
                document.getElementById('osc_listen_port').value = config.osc.listen_port;
                document.getElementById('web_listen_host').value = config.web_server.listen_host;
                document.getElementById('web_listen_port').value = config.web_server.listen_port;

                // Populate Advanced settings
                document.getElementById('log_level').value = config.log_level;
                document.getElementById('auto_open_web_page').checked = config.general.auto_open_web_page;

                showAlert('配置加载成功', 'success');
            } catch (error) {
                console.error('Error loading config:', error);
                showAlert('配置加载失败: ' + error.message, 'danger');
            }
        }

        // Save configuration to server
        async function saveConfig() {
            try {
                const config = {
                    osr2: {
                        com_port: document.getElementById('com_port').value,
                        use_udp: document.getElementById('use_udp').checked,
                        udp_server_ip: document.getElementById('udp_server_ip').value,
                        udp_server_port: parseInt(document.getElementById('udp_server_port').value),
                        objective: document.getElementById('objective').value,
                        max_pos: parseInt(document.getElementById('max_pos').value),
                        min_pos: parseInt(document.getElementById('min_pos').value),
                        max_velocity: parseInt(document.getElementById('max_velocity').value),
                        updates_per_second: parseInt(document.getElementById('updates_per_second').value),
                        l0_axis_invert: document.getElementById('l0_axis_invert').checked,
                        vrchat_max: parseInt(document.getElementById('vrchat_max').value),
                        vrchat_min: parseInt(document.getElementById('vrchat_min').value),
                        inserting_others: document.getElementById('inserting_others').value,
                        inserting_self: document.getElementById('inserting_self').value,
                        inserted_pussy: document.getElementById('inserted_pussy').value,
                        inserted_ass: document.getElementById('inserted_ass').value
                    },
                    osc: {
                        listen_host: document.getElementById('osc_listen_host').value,
                        listen_port: parseInt(document.getElementById('osc_listen_port').value)
                    },
                    web_server: {
                        listen_host: document.getElementById('web_listen_host').value,
                        listen_port: parseInt(document.getElementById('web_listen_port').value)
                    },
                    log_level: document.getElementById('log_level').value,
                    general: {
                        auto_open_web_page: document.getElementById('auto_open_web_page').checked
                    }
                };

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showAlert('配置保存成功！需要重启程序以应用更改。', 'success');
                } else {
                    throw new Error('保存失败');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showAlert('配置保存失败: ' + error.message, 'danger');
            }
        }



        // Update status indicators
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // Update device status
                const deviceStatus = document.getElementById('device-status');
                const deviceText = document.getElementById('device-text');
                if (status.device_connected) {
                    deviceStatus.className = 'status-indicator status-connected';
                    deviceText.textContent = '已连接';
                } else {
                    deviceStatus.className = 'status-indicator status-disconnected';
                    deviceText.textContent = '未连接';
                }

                // Update OSC status
                const oscStatus = document.getElementById('osc-status');
                const oscText = document.getElementById('osc-text');
                if (status.osc_running) {
                    oscStatus.className = 'status-indicator status-connected';
                    oscText.textContent = '运行中';
                } else {
                    oscStatus.className = 'status-indicator status-disconnected';
                    oscText.textContent = '未运行';
                }

                // Update running status
                const runningStatus = document.getElementById('running-status');
                const runningText = document.getElementById('running-text');
                if (status.main_running) {
                    runningStatus.className = 'status-indicator status-connected';
                    runningText.textContent = '运行中';
                } else {
                    runningStatus.className = 'status-indicator status-disconnected';
                    runningText.textContent = '已停止';
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Restart backend
        async function restartBackend() {
            try {
                showAlert('正在重启后端程序...', 'info');

                const response = await fetch('/restart', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('后端程序重启成功！', 'success');
                    // 延迟更新状态，给后端时间启动
                    setTimeout(() => {
                        updateStatus();
                    }, 2000);
                } else {
                    throw new Error(result.message || '重启失败');
                }
            } catch (error) {
                console.error('Error restarting backend:', error);
                showAlert('后端程序重启失败: ' + error.message, 'danger');
            }
        }

        // OSR Position Control Functions
        async function moveToMaxPosition() {
            try {
                showAlert('正在移动到最大位置...', 'info');

                const response = await fetch('/api/osr/move-max', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('已移动到最大位置！', 'success');
                } else {
                    throw new Error(result.message || '移动失败');
                }
            } catch (error) {
                console.error('Error moving to max position:', error);
                showAlert('移动到最大位置失败: ' + error.message, 'danger');
            }
        }

        async function moveToMinPosition() {
            try {
                showAlert('正在移动到最小位置...', 'info');

                const response = await fetch('/api/osr/move-min', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('已移动到最小位置！', 'success');
                } else {
                    throw new Error(result.message || '移动失败');
                }
            } catch (error) {
                console.error('Error moving to min position:', error);
                showAlert('移动到最小位置失败: ' + error.message, 'danger');
            }
        }

        // Show alert message
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Insert alert at the top of the config section
            const configSection = document.querySelector('.config-section');
            configSection.insertBefore(alertDiv, configSection.firstChild);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Chart functionality
        let charts = [];
        let chartUpdateInterval = null;

        function createChart(container, chartTitle) {
            const w = container.clientWidth;
            const h = container.clientHeight - 30; // Account for title

            const opts = {
                width: w,
                height: h,
                scales: {
                    x: { time: true },
                    y: { auto: true },
                },
                series: [
                    { label: "Time" },
                    { label: "Value", stroke: "#007bff", width: 2 },
                ],
                axes: [
                    {
                        stroke: "#666",
                        grid: { stroke: "#333" },
                    },
                    {
                        stroke: "#666",
                        grid: { stroke: "#333" },
                    },
                ],
            };

            const data = [[], []];
            return new uPlot(opts, data, container);
        }

        function initializeCharts() {
            const containers = [
                document.getElementById('chart-container-1'),
                document.getElementById('chart-container-2'),
                document.getElementById('chart-container-3'),
                document.getElementById('chart-container-4'),
                document.getElementById('chart-container-5'),
                document.getElementById('chart-container-6'),
            ];

            const chartTitles = [
                "Raw Level",
                "Raw Velocity",
                "Raw Acceleration",
                "Cropped Velocity",
                "Cropped Acceleration",
                "Output Level",
            ];

            charts = containers.map((el, i) => {
                if (el) {
                    return createChart(el, chartTitles[i]);
                }
                return null;
            }).filter(chart => chart !== null);
        }

        async function fetchDataAndUpdate() {
            try {
                const response = await fetch("/api/data");
                const result = await response.json();

                const xData = result.timestamps;
                for (let i = 0; i < charts.length && i < result.lines.length; i++) {
                    const yData = result.lines[i];
                    if (charts[i]) {
                        charts[i].setData([xData, yData]);
                    }
                }
            } catch (error) {
                console.error("Error fetching chart data:", error);
            }
        }

        function startChartUpdates() {
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
            }
            chartUpdateInterval = setInterval(fetchDataAndUpdate, 100);
        }

        function stopChartUpdates() {
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
                chartUpdateInterval = null;
            }
        }

        // Handle tab switching
        document.addEventListener('shown.bs.tab', function (event) {
            if (event.target.id === 'monitor-tab') {
                setTimeout(() => {
                    initializeCharts();
                    startChartUpdates();
                }, 100);
            } else {
                stopChartUpdates();
            }
        });
    </script>
</body>

</html>